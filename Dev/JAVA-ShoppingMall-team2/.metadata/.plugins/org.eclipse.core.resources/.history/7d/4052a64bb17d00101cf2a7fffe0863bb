package com.shopping.controller;

import java.util.ArrayList;
import java.util.List;
import java.util.Scanner;

import com.shopping.model.Admin;
import com.shopping.model.Order;
import com.shopping.model.User;
import com.shopping.repository.FileAdminRepository;
import com.shopping.repository.FileUserRepository;
import com.shopping.service.AuthService;
import com.shopping.service.UserService;

public class UserController {
	private UserService userService;
	private AuthService authService;
	private Scanner scanner;
	
	// ë‹¤ë¥¸ ì»¨íŠ¸ë¡¤ëŸ¬ë“¤ì„ ë©¤ë²„ ë³€ìˆ˜ë¡œ ì„ ì–¸í•©ë‹ˆë‹¤.
	private ProductController productController;
	private CartController cartController;
	private List<Order> orders; // ì£¼ë¬¸ ë‚´ì—­ì„ ì €ì¥í•  ì„ì‹œ ì €ì¥ì†Œ

	// UserController ìƒì„±ì
	public UserController(UserService userService, AuthService authService, Scanner scanner) {
		this.userService = userService;
		this.authService = authService;
		this.scanner = scanner;
		this.orders = new ArrayList<>(); // ì£¼ë¬¸ ë‚´ì—­ ë¦¬ìŠ¤íŠ¸ ì´ˆê¸°í™”
	}
	
	// ë‹¤ë¥¸ ì»¨íŠ¸ë¡¤ëŸ¬ ê°ì²´ë¥¼ ì„¤ì •í•˜ëŠ” ë©”ì„œë“œ (ì˜ì¡´ì„± ì£¼ì…)
	public void setOtherControllers(ProductController productController, CartController cartController) {
		this.productController = productController;
		this.cartController = cartController;
	}

	// ë¡œê·¸ì¸ ì„±ê³µ í›„ í˜¸ì¶œ
	public void showShoppingUserMenu(User user) {
	    while (true) {
	        System.out.println("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
	        System.out.println("â•‘     ğŸ›ï¸  Java Shopping Mall                 â•‘");
	        System.out.println("â•‘     í™˜ì˜í•©ë‹ˆë‹¤, " + user.getName() + "ë‹˜!                  â•‘");
	        System.out.println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");

	        System.out.println("1. ìƒí’ˆ ë‘˜ëŸ¬ë³´ê¸°");
	        System.out.println("2. ìƒí’ˆ ê²€ìƒ‰");
	        System.out.println("3. ì¥ë°”êµ¬ë‹ˆ ê´€ë¦¬");
	        System.out.println("4. ì£¼ë¬¸í•˜ê¸°");
	        System.out.println("5. ì£¼ë¬¸ ë‚´ì—­");
	        System.out.println("6. ë§ˆì´í˜ì´ì§€");
	        System.out.println("7. ë¡œê·¸ì•„ì›ƒ");
	        System.out.print("\në©”ë‰´ë¥¼ ì„ íƒí•˜ì„¸ìš”: ");

	        String choice = scanner.nextLine();
	        
	        switch (choice) {
            case "1":
            	browseProducts(); //ìƒí’ˆ ë‘˜ëŸ¬ë³´ê¸°
                break;
            case "2":
            	searchProducts(); // ìƒí’ˆ ê²€ìƒ‰
                break;
            case "3":
            	manageCart(); // ì¥ë°”êµ¬ë‹ˆ ê´€ë¦¬
                break;
            case "4":
            	Order(); // ì£¼ë¬¸í•˜ê¸°
                break;
            case "5":
            	ByingList(); // ì£¼ë¬¸ ë‚´ì—­
                break;
            case "6":
            	myPage(user); // user ê°ì²´ë¥¼ ë„˜ê²¨ì£¼ë„ë¡ ìˆ˜ì •
                break;
            case "7":
                logout(); // ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
                return;   // ë©”ë‰´ ì¢…ë£Œ
            default:
                System.out.println("ì˜ëª»ëœ ì„ íƒì…ë‹ˆë‹¤.");
        }
    }
}

	private void logout() {
		Object nowLoginObj = authService.getLoggedInUser();
		if (nowLoginObj == null) {
			System.out.println("ë¡œê·¸ì¸ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.");
			return;
		}
		
		String userName = (nowLoginObj instanceof User ? ((User)nowLoginObj).getName() : ((Admin)nowLoginObj).getName());
		authService.logout();
		System.out.println(userName + "ë‹˜ì´ ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.");
	}

	// myPage ë©”ì„œë“œ êµ¬í˜„ (ê°„ë‹¨í•œ ì˜ˆì‹œ)
	// ê¸°ì¡´ ì½”ë“œì—ì„œ myPage(session)ì„ myPage(user)ë¡œ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤.
	private void myPage(User user) {
		System.out.println("\n--- ë§ˆì´í˜ì´ì§€ ---");
		System.out.println("ì´ë¦„: " + user.getName());
		System.out.println("ì•„ì´ë””: " + user.getId());
		
		System.out.println("-----------------");
	}

	private void manageCart() {
		if (cartController != null) {
			cartController.menu();      // ì¥ë°”êµ¬ë‹ˆ ë©”ë‰´ ì‹¤í–‰
		} else {
			System.out.println("ì¥ë°”êµ¬ë‹ˆ ê´€ë¦¬ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
		}
	}

	private void searchProducts() {
		if (productController != null) {
			productController.search(); // ìƒí’ˆ ê²€ìƒ‰ ê¸°ëŠ¥
		} else {
			System.out.println("ìƒí’ˆ ê²€ìƒ‰ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
		}
	}

	private void browseProducts() {
		if (productController != null) {
			productController.list();   // ìƒí’ˆ ëª©ë¡ ë³´ì—¬ì£¼ê¸°
		} else {
			System.out.println("ìƒí’ˆ ë‘˜ëŸ¬ë³´ê¸° ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
		}
	}
	
	/**
     * @brief ì¥ë°”êµ¬ë‹ˆì— ë‹´ê¸´ ìƒí’ˆì„ ì£¼ë¬¸í•˜ëŠ” ë©”ì„œë“œ.
     * 1. í˜„ì¬ ë¡œê·¸ì¸ëœ ì‚¬ìš©ìì˜ ì¥ë°”êµ¬ë‹ˆë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
     * 2. ì¥ë°”êµ¬ë‹ˆì— ìƒí’ˆì´ ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
     * 3. ì£¼ë¬¸ ì •ë³´ë¥¼ ìƒì„±í•˜ê³ , ì£¼ë¬¸ ë‚´ì—­ ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€í•©ë‹ˆë‹¤.
     * 4. ì¥ë°”êµ¬ë‹ˆë¥¼ ë¹„ì›ë‹ˆë‹¤.
     */
	private void Order() {
		User currentUser = (User) authService.getLoggedInUser();
		if (currentUser == null) {
			System.out.println("ë¡œê·¸ì¸ í›„ ì´ìš©í•´ ì£¼ì„¸ìš”.");
			return;
		}
		
		// ì¥ë°”êµ¬ë‹ˆì— ìƒí’ˆì´ ìˆëŠ”ì§€ í™•ì¸
		List<CartItem> cartItems = cartController.getCartItems(currentUser);
		if (cartItems.isEmpty()) {
			System.out.println("ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ ìˆì–´ ì£¼ë¬¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
			return;
		}
		
		System.out.println("\n--- ì£¼ë¬¸í•˜ê¸° ---");
		System.out.println("ì£¼ë¬¸í•˜ì‹¤ ìƒí’ˆ ëª©ë¡:");
		double totalAmount = 0;
		for (CartItem item : cartItems) {
			System.out.printf("- %s (%dê°œ) - %,.0fì›\n", item.getProduct().getName(), item.getQuantity(), item.getTotalPrice());
			totalAmount += item.getTotalPrice();
		}
		System.out.println("ì´ ê²°ì œ ê¸ˆì•¡: " + (int)totalAmount + "ì›");
		System.out.print("ì£¼ë¬¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (Y/N): ");
		String confirm = scanner.nextLine();
		
		if (confirm.equalsIgnoreCase("Y")) {
			// ì£¼ë¬¸ ë²ˆí˜¸ ìƒì„± (ê°„ë‹¨í•œ ì˜ˆì‹œ)
			String orderId = "ORD-" + System.currentTimeMillis();
			// ìƒˆë¡œìš´ ì£¼ë¬¸ ê°ì²´ ìƒì„±
			Order newOrder = new Order(orderId, currentUser.getId(), cartItems, totalAmount);
			// ì£¼ë¬¸ ë‚´ì—­ ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€
			orders.add(newOrder);
			
			// ì¥ë°”êµ¬ë‹ˆ ë¹„ìš°ê¸°
			cartController.clearCart(currentUser);
			
			System.out.println("\nâœ… ì£¼ë¬¸ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
			System.out.println("ì£¼ë¬¸ ë²ˆí˜¸: " + orderId);
		} else {
			System.out.println("ì£¼ë¬¸ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
		}
	}

	/**
     * @brief ë¡œê·¸ì¸ëœ ì‚¬ìš©ìì˜ ì£¼ë¬¸ ë‚´ì—­ì„ ì¡°íšŒí•˜ê³  ì¶œë ¥í•˜ëŠ” ë©”ì„œë“œ.
     * 1. í˜„ì¬ ë¡œê·¸ì¸ëœ ì‚¬ìš©ìì˜ ì£¼ë¬¸ ë‚´ì—­ì„ í•„í„°ë§í•©ë‹ˆë‹¤.
     * 2. ì£¼ë¬¸ì´ ì—†ìœ¼ë©´ ë©”ì‹œì§€ë¥¼ ì¶œë ¥í•©ë‹ˆë‹¤.
     * 3. ì£¼ë¬¸ ë‚´ì—­ì„ ìˆœíšŒí•˜ë©° ìƒì„¸ ì •ë³´ë¥¼ ì¶œë ¥í•©ë‹ˆë‹¤.
     */
	private void ByingList() {
		User currentUser = (User) authService.getLoggedInUser();
		if (currentUser == null) {
			System.out.println("ë¡œê·¸ì¸ í›„ ì´ìš©í•´ ì£¼ì„¸ìš”.");
			return;
		}
		
		// í˜„ì¬ ì‚¬ìš©ìì˜ ì£¼ë¬¸ ë‚´ì—­ë§Œ í•„í„°ë§
		List<Order> userOrders = new ArrayList<>();
		for (Order order : orders) {
			if (order.getUserId().equals(currentUser.getId())) {
				userOrders.add(order);
			}
		}
		
		System.out.println("\n--- " + currentUser.getName() + "ë‹˜ì˜ ì£¼ë¬¸ ë‚´ì—­ ---");
		if (userOrders.isEmpty()) {
			System.out.println("ì£¼ë¬¸ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.");
		} else {
			DateTimeFormatter formatter = DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss");
			
			for (Order order : userOrders) {
				System.out.println("------------------------------------");
				System.out.println("ì£¼ë¬¸ ë²ˆí˜¸: " + order.getOrderId());
				System.out.println("ì£¼ë¬¸ ë‚ ì§œ: " + order.getOrderDate().format(formatter));
				System.out.println("ì´ ê²°ì œ ê¸ˆì•¡: " + (int)order.getTotalAmount() + "ì›");
				System.out.println("ìƒí’ˆ ëª©ë¡:");
				for (CartItem item : order.getItems()) {
					System.out.printf("  - %s (%dê°œ) - %,.0fì›\n", item.getProduct().getName(), item.getQuantity(), item.getTotalPrice());
				}
			}
			System.out.println("------------------------------------");
		}
	}
}
